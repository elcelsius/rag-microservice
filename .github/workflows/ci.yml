name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run pytest
        run: python -m pytest

  smoke:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Copy env defaults
        run: cp .env.example .env
      - name: Start services
        run: docker-compose -f docker-compose.cpu.yml up -d ai_projeto_api ai_web_ui
      - name: Wait for API health
        run: |
          sudo apt-get update && sudo apt-get install -y jq >/dev/null
          for i in {1..30}; do
            if curl -fsS http://localhost:8080/api/healthz >/dev/null; then
              curl -fsS http://localhost:8080/api/healthz | jq '.'
              exit 0
            fi
            sleep 5
          done
          echo 'API nÃ£o ficou pronta a tempo' >&2
          docker-compose -f docker-compose.cpu.yml logs ai_projeto_api
          exit 1
      - name: Smoke API
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python scripts/smoke_api.py http://localhost:8080/api
      - name: docker logs (on failure)
        if: failure()
        run: docker-compose -f docker-compose.cpu.yml logs ai_projeto_api
      - name: Shutdown
        if: always()
        run: docker-compose -f docker-compose.cpu.yml down

