# Dockerfile.cpu
# Imagem multi-stage para construir e executar o microsserviço RAG em ambiente CPU.

FROM python:3.11-slim AS builder

WORKDIR /app

# Ajusta repositórios para https (evita bloqueios de rede http)
RUN sed -i "s|http://deb.debian.org|https://deb.debian.org|g; s|http://security.debian.org|https://security.debian.org|g" /etc/apt/sources.list.d/debian.sources

# Dependências necessárias apenas em build-time.
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential git curl \
 && rm -rf /var/lib/apt/lists/*

# Cria um ambiente virtual isolado para reutilizar nas fases seguintes.
ENV VENV_PATH=/opt/venv
RUN python3 -m venv ${VENV_PATH}
ENV PATH="${VENV_PATH}/bin:$PATH"
ENV HF_HOME=/opt/hf-cache

COPY requirements.txt requirements-cpu.txt ./
RUN pip install --no-cache-dir --upgrade pip \
 && pip install --no-cache-dir -r requirements-cpu.txt \
 && python -c "from huggingface_hub import snapshot_download; snapshot_download('intfloat/multilingual-e5-large', max_workers=8)" \
 && python -c "from huggingface_hub import snapshot_download; snapshot_download('cross-encoder/ms-marco-MiniLM-L-6-v2', max_workers=8)"

#--------------------------------------------------------------
# Camada de runtime compartilhada entre API e ETL
FROM python:3.11-slim AS runtime

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    poppler-utils \
 && rm -rf /var/lib/apt/lists/*

ENV VENV_PATH=/opt/venv
COPY --from=builder ${VENV_PATH} ${VENV_PATH}
ENV PATH="${VENV_PATH}/bin:$PATH" \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    HF_HOME=/opt/hf-cache

COPY --from=builder /opt/hf-cache /opt/hf-cache

# Copia apenas os artefatos necessários para execução.
COPY api.py ./
COPY agent_workflow.py ./
COPY llm_client.py ./
COPY query_handler.py ./
COPY text_normalizer.py ./
COPY telemetry.py ./
COPY triage.py ./
COPY etl_orchestrator.py ./
COPY eval_rag.py ./
COPY cache_backend.py ./
COPY loaders ./loaders
COPY prompts ./prompts
COPY scripts ./scripts
COPY tools ./tools
COPY config ./config

#--------------------------------------------------------------
# Imagem para ETL (rebuild/update de índice)
FROM runtime AS etl
CMD ["python3", "-u", "etl_orchestrator.py"]

#--------------------------------------------------------------
# Imagem para API Flask
FROM runtime AS ai_api
EXPOSE 5000
CMD ["python3", "-u", "api.py"]
