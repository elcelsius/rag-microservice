# Dockerfile.gpu
# Fluxo multi-stage para executar o microsserviço RAG com suporte a GPU (CUDA 12.1).

FROM python:3.11-slim AS builder

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential git curl \
 && rm -rf /var/lib/apt/lists/*

ENV VENV_PATH=/opt/venv
RUN python3 -m venv ${VENV_PATH}
ENV PATH="${VENV_PATH}/bin:$PATH"

# Atualiza pip e instala PyTorch com CUDA antes das demais dependências.
RUN pip install --no-cache-dir --upgrade pip \
 && pip install --no-cache-dir --index-url https://download.pytorch.org/whl/cu121 \
    torch torchvision torchaudio

COPY requirements.txt requirements-gpu.txt ./
RUN pip install --no-cache-dir -r requirements-gpu.txt

#--------------------------------------------------------------
FROM python:3.11-slim AS runtime

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    poppler-utils \
 && rm -rf /var/lib/apt/lists/*

ENV VENV_PATH=/opt/venv
COPY --from=builder ${VENV_PATH} ${VENV_PATH}
ENV PATH="${VENV_PATH}/bin:$PATH" \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

COPY api.py ./
COPY agent_workflow.py ./
COPY llm_client.py ./
COPY query_handler.py ./
COPY telemetry.py ./
COPY triage.py ./
COPY etl_orchestrator.py ./
COPY eval_rag.py ./
COPY loaders ./loaders
COPY prompts ./prompts
COPY scripts ./scripts
COPY tools ./tools
COPY config ./config

#--------------------------------------------------------------
FROM runtime AS etl
CMD ["python3", "-u", "etl_orchestrator.py"]

#--------------------------------------------------------------
FROM runtime AS ai_api
EXPOSE 5000
CMD ["python3", "-u", "api.py"]
